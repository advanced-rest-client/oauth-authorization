<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

  <script type="module" src="../oauth1-authorization.js"></script>
  <script src="../../../cryptojslib/components/core.js"></script>
  <script src="../../../cryptojslib/rollups/sha1.js"></script>
  <script src="../../../cryptojslib/components/enc-base64-min.js"></script>
  <script src="../../../cryptojslib/rollups/md5.js"></script>
  <script src="../../../cryptojslib/rollups/hmac-sha1.js"></script>
  <script src="../../../jsrsasign/lib/jsrsasign-rsa-min.js"></script>
</head>

<body>
  <test-fixture id="basic">
    <template>
      <oauth1-authorization></oauth1-authorization>
    </template>
  </test-fixture>
  <script type="module">
  import {afterNextRender} from '../../../@polymer/polymer/lib/utils/render-status.js';
  // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
  // jscs:disable requireDotNotation
  suite('Before request - OAuth1', () => {
    let element;
    let request;
    let auth;
    setup((done) => {
      element = fixture('basic');
      request = {
        url: 'http://domain.com/endpoint/?param=value',
        headers: 'x-requested-with: xmlhttprequest',
        method: 'GET'
      };
      auth = {
        signatureMethod: 'HMAC-SHA1',
        requestTokenUri: 'https://echo.advancedrestclient.com/auth/oauth1/request_token',
        accessTokenUri: 'https://echo.advancedrestclient.com/auth/oauth1/access_token',
        authorizationUri: 'https://echo.advancedrestclient.com/auth/oauth1/dialog/authorize',
        consumerKey: 'key',
        consumerSecret: 'secret',
        redirectUri: 'http://127.0.0.1:8081/components/oauth-authorization/oauth-popup.html',
        authParamsLocation: 'authorization',
        authTokenMethod: 'POST',
        nonce: 'abcdefg',
        timestamp: 1509402152,
        token: 'tWfvyFw7anQYC0Fo',
        tokenSecret: 'kOZA2NjIVQ1c8pUZ6Ku2c2Rs16aGeYnJHlZL7Kg2jFAfmigL1uFSUHNO5zLkkIru',
        type: 'oauth1'
      };
      // Event listeners are deffered. It must account for this
      afterNextRender(window, () => {
        setTimeout(() => done(), 1);
      });
    });

    function fire() {
      const detail = Object.assign ? Object.assign({}, request) : request;
      detail.auth = auth;
      const event = new CustomEvent('before-request', {
        detail: detail,
        bubbles: true,
        composed: true
      });
      document.body.dispatchEvent(event);
      return event;
    }

    test('Handles before-request event', () => {
      const event = fire();
      const headers = event.detail.headers;
      assert.typeOf(headers, 'string');
      assert.isTrue(headers.toLowerCase().indexOf('authorization') !== -1);
    });

    test('Generates signature', () => {
      let event = fire();
      let headers = event.detail.headers;
      let index = headers.indexOf('authorization');
      let value = headers.substr(index + 15 + 6);
      let params = {};
      value.split(', ').forEach(function(line) {
        let parts = line.split('=');
        let _value = parts[1].substr(1);
        _value = _value.substr(0, _value.length - 1);
        params[parts[0]] = _value;
      });
      assert.equal(params.oauth_consumer_key, auth.consumerKey);
      assert.equal(params.oauth_nonce, auth.nonce);
      assert.equal(params.oauth_signature_method, auth.signatureMethod);
      assert.equal(params.oauth_timestamp, auth.timestamp);
      assert.equal(params.oauth_token, auth.token);
      assert.equal(params.oauth_version, '1.0');
      assert.equal(params.oauth_signature, '4huy8JcLkX8bch540ZTXiwH%2B4Vc%3D');
    });
  });
  </script>
</body>

</html>
