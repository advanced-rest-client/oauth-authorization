<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

  <script src="../../../cryptojslib/components/core.js"></script>
  <script src="../../../cryptojslib/rollups/sha1.js"></script>
  <script src="../../../cryptojslib/components/enc-base64-min.js"></script>
  <script src="../../../cryptojslib/rollups/md5.js"></script>
  <script src="../../../cryptojslib/rollups/hmac-sha1.js"></script>
  <script src="../../../jsrsasign/lib/jsrsasign-rsa-min.js"></script>
  <script type="module" src="../oauth1-authorization.js"></script>
</head>

<body>
  <test-fixture id="basic">
    <template>
      <oauth1-authorization></oauth1-authorization>
    </template>
  </test-fixture>
  <script type="module">
  // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
  // jscs:disable requireDotNotation
  suite('Signature generator', function() {
    suite('_listQueryParameters()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      [{
        url: 'http://domain.com',
        result: []
      }, {
        url: 'http://domain.com/path/file.html',
        result: []
      }, {
        url: 'http://domain.com/path/file.html?',
        result: []
      }, {
        url: 'http://domain.com/path/file.html?param=value',
        result: [['param', 'value']]
      }, {
        url: 'http://domain.com/path/file.html?param=value&a',
        result: [['param', 'value'], ['a', '']]
      }, {
        url: 'http://domain.com/path/file.html?param=value&a=&test#123',
        result: [['param', 'value'], ['a', ''], ['test', '']]
      }].forEach(function(item) {
        test('Parses ' + item.url, function() {
          var params = element._listQueryParameters(item.url);
          assert.lengthOf(params, item.result.length, 'Length is OK');
          assert.deepEqual(params, item.result, 'Result is OK');
        });
      });
    });

    suite('_makeArrayOfArgumentsHash()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      var simpleMap = {
        param: 'value',
        number: 123,
        boolean: true
      };

      var mapWithArray = {
        param: 'value',
        number: 123,
        boolean: true,
        array: ['one', 'two', 'tree']
      };

      test('Transforms simple map to array', function() {
        var params = element._makeArrayOfArgumentsHash(simpleMap);
        assert.typeOf(params, 'array');
      });

      test('Simple map to array has 3 elements', function() {
        var params = element._makeArrayOfArgumentsHash(simpleMap);
        assert.lengthOf(params, Object.keys(simpleMap).length);
      });

      test('Preserves order in array', function() {
        var params = element._makeArrayOfArgumentsHash(simpleMap);
        assert.equal(params[0][0], 'param');
        assert.equal(params[1][0], 'number');
        assert.equal(params[2][0], 'boolean');
      });

      test('Sets values in array', function() {
        var params = element._makeArrayOfArgumentsHash(simpleMap);
        assert.equal(params[0][1], 'value');
        assert.equal(params[1][1], 123);
        assert.equal(params[2][1], true);
      });

      test('Transforms map with array to array', function() {
        var params = element._makeArrayOfArgumentsHash(mapWithArray);
        assert.typeOf(params, 'array');
      });

      test('Map with array has 6 elements', function() {
        var params = element._makeArrayOfArgumentsHash(mapWithArray);
        assert.lengthOf(params, 6);
      });

      test('Preservers array items order', function() {
        var params = element._makeArrayOfArgumentsHash(mapWithArray);
        assert.equal(params[3][1], 'one');
        assert.equal(params[4][1], 'two');
        assert.equal(params[5][1], 'tree');
      });
    });

    suite('_normalizeUrl()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      var urlDefaultPort = 'http://EXAMPLE.COM:80/r%20v/X?id=123#123';
      var urlNonDefaultPort = 'https://www.example.net:8080/?q=1';
      var urlPortMissmatch = 'http://www.example.net:443/';

      test('Removes query string, port and lowercase the URL', function() {
        var url = element._normalizeUrl(urlDefaultPort);
        assert.strictEqual(url, 'http://example.com/r%20v/X');
      });

      test('Removes query string, preserves port', function() {
        var url = element._normalizeUrl(urlNonDefaultPort);
        assert.strictEqual(url, 'https://www.example.net:8080/');
      });

      test('Preserves port', function() {
        var url = element._normalizeUrl(urlPortMissmatch);
        assert.strictEqual(url, 'http://www.example.net:443/');
      });
    });

    suite('_sortParamsFunction()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      // https://tools.ietf.org/html/rfc5849#section-3.4.1.3.2
      test('Sorts an array by first parameter', function() {
        var array = [
          ['b5', '%3D%253D'],
          ['a3', 'a'],
          ['c%40', ''],
          ['a2', 'r%20b'],
          ['oauth_consumer_key', '9djdj82h48djs9d2'],
          ['oauth_token', 'kkk9d7dh3k39sjv7'],
          ['oauth_signature_method', 'HMAC-SHA1'],
          ['oauth_timestamp', 137131201],
          ['oauth_nonce', '7d8f3e4a'],
          ['c2', ''],
          ['a3', '2%20q']
        ];
        var compare = [
          ['a2', 'r%20b'],
          ['a3', '2%20q'],
          ['a3', 'a'],
          ['b5', '%3D%253D'],
          ['c%40', ''],
          ['c2', ''],
          ['oauth_consumer_key', '9djdj82h48djs9d2'],
          ['oauth_nonce', '7d8f3e4a'],
          ['oauth_signature_method', 'HMAC-SHA1'],
          ['oauth_timestamp', 137131201],
          ['oauth_token', 'kkk9d7dh3k39sjv7']
        ];
        array.sort(element._sortParamsFunction);
        assert.deepEqual(array, compare);
      });
    });

    suite('_normaliseRequestParams()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      // https://tools.ietf.org/html/rfc5849#section-3.4.1.3.2
      test('Normalises params', function() {
        var array = [
          ['b5', '=%3D'],
          ['a3', 'a'],
          ['c@', ''],
          ['a2', 'r b'],
          ['oauth_consumer_key', '9djdj82h48djs9d2'],
          ['oauth_token', 'kkk9d7dh3k39sjv7'],
          ['oauth_signature_method', 'HMAC-SHA1'],
          ['oauth_timestamp', 137131201],
          ['oauth_nonce', '7d8f3e4a'],
          ['c2', ''],
          ['a3', '2 q']
        ];
        var compare = 'a2=r%20b&a3=2%20q&a3=a&b5=%3D%253D&c%40=&c2=&';
        compare += 'oauth_consumer_key=9djdj82h48djs9d2&';
        compare += 'oauth_nonce=7d8f3e4a&oauth_signature_method=HMAC-SHA1&';
        compare += 'oauth_timestamp=137131201&oauth_token=kkk9d7dh3k39sjv7';
        var normalised = element._normaliseRequestParams(array);
        assert.equal(normalised, compare);
      });
    });

    suite('_formUrlEncodedToParams()', function() {
      var body = 'c2&a3=2+q&key=';
      var params;
      setup(function() {
        var element = fixture('basic');
        params = element._formUrlEncodedToParams(body);
      });

      test('Creates array from form URL encoded body', function() {
        assert.typeOf(params, 'array');
      });

      test('Array has 3 elements', function() {
        assert.lengthOf(params, 3);
      });

      test('Preserves order', function() {
        assert.equal(params[0][0], 'c2');
        assert.equal(params[1][0], 'a3');
        assert.equal(params[2][0], 'key');
      });

      test('Decodes parameters', function() {
        assert.equal(params[1][1], '2 q');
      });
    });

    suite('createSignatureBase()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      var oauthParams = {
        oauth_consumer_key: '9djdj82h48djs9d2',
        oauth_token: 'kkk9d7dh3k39sjv7',
        oauth_signature_method: 'HMAC-SHA1',
        oauth_timestamp: 137131201,
        oauth_nonce: '7d8f3e4a'
      };

      var url = 'http://example.com/request?b5=%3D%253D&a3=a&c%40=&a2=r%20b';
      var body = 'c2&a3=2+q';
      var method = 'POST';

      // https://tools.ietf.org/html/rfc5849#section-3.4.1.1
      test('Computes signature base without body', function() {
        var compare = 'POST&http%3A%2F%2Fexample.com%2Frequest&a2%3Dr%2520b%26';
        compare += 'a3%3Da%26b5%3D%253D%25253D%26c%2540%3D';
        compare += '%26oauth_consumer_key%3D9djdj82h48djs9d2%26oauth_nonce';
        compare += '%3D7d8f3e4a%26oauth_signature_method%3DHMAC-SHA1%26oauth_';
        compare += 'timestamp%3D137131201%26oauth_token%3Dkkk9d7dh3k39sjv7';
        var normalised = element.createSignatureBase(method, url, oauthParams);
        assert.equal(normalised, compare);
      });

      test('Computes signature base without body', function() {
        var compare = 'POST&http%3A%2F%2Fexample.com%2Frequest&a2%3Dr%2520b%26';
        compare += 'a3%3D2%2520q%26a3%3Da%26b5%3D%253D%25253D%26c%2540%3D%26c2';
        compare += '%3D%26oauth_consumer_key%3D9djdj82h48djs9d2%26oauth_nonce';
        compare += '%3D7d8f3e4a%26oauth_signature_method%3DHMAC-SHA1%26oauth_';
        compare += 'timestamp%3D137131201%26oauth_token%3Dkkk9d7dh3k39sjv7';
        var normalised = element.createSignatureBase(method, url, oauthParams, body);
        assert.equal(normalised, compare);
      });
    });

    // http://lti.tools/oauth/
    suite('createSignatureBase() 2', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      var oauthParams = {
        oauth_consumer_key: '9djdj82h48djs9d2',
        oauth_token: 'kkk9d7dh3k39sjv7',
        oauth_signature_method: 'HMAC-SHA1',
        oauth_timestamp: 137131201,
        oauth_nonce: '7d8f3e4a'
      };
      var url = 'http://example.com/request?param=value';
      var method = 'POST';
      test('Computes base string', function() {
        var base = element.createSignatureBase(method, url, oauthParams);
        var compare = 'POST&http%3A%2F%2Fexample.com%2Frequest&oauth_consumer_';
        compare += 'key%3D9djdj82h48djs9d2%26oauth_nonce%3D7d8f3e4a%26oauth_si';
        compare += 'gnature_method%3DHMAC-SHA1%26oauth_timestamp%3D137131201%2';
        compare += '6oauth_token%3Dkkk9d7dh3k39sjv7%26param%3Dvalue';
        assert.equal(base, compare);
      });

      test('Computes base string with body', function() {
        var body = 'bodyParam=bodyValue';
        var base = element.createSignatureBase('GET', url, oauthParams, body);
        var compare = 'GET&http%3A%2F%2Fexample.com%2Frequest&bodyParam%3Dbody';
        compare += 'Value%26oauth_consumer_key%3D9djdj82h48djs9d2%26oauth_nonc';
        compare += 'e%3D7d8f3e4a%26oauth_signature_method%3DHMAC-SHA1%26oauth_';
        compare += 'timestamp%3D137131201%26oauth_token%3Dkkk9d7dh3k39sjv7%26p';
        compare += 'aram%3Dvalue';
        assert.equal(base, compare);
      });

      test('Computes base string with callback parameter', function() {
        var oauthParams = {
          oauth_consumer_key: 'key',
          oauth_signature_method: 'HMAC-SHA1',
          oauth_timestamp: 1500143520,
          oauth_nonce: 'KoirwhdQhaHOuviMm1YydjVlcOZxJvOr',
          oauth_version: '1.0',
          oauth_callback: 'http://192.168.1.16:8081/components/auth-methods/demo/oauth1.html'
        };
        var url = 'http://term.ie/oauth/example/request_token.php';
        var base = element.createSignatureBase('POST', url, oauthParams);
        var compare = 'POST&http%3A%2F%2Fterm.ie%2Foauth%2Fexample%2Frequest_' +
          'token.php&oauth_callback%3Dhttp%253A%252F%252F192.168.1.16%253A808' +
          '1%252Fcomponents%252Fauth-methods%252Fdemo%252Foauth1.html%26oauth' +
          '_consumer_key%3Dkey%26oauth_nonce%3DKoirwhdQhaHOuviMm1YydjVlcOZxJv' +
          'Or%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D150014' +
          '3520%26oauth_version%3D1.0';
        assert.equal(base, compare);
      });
    });

    // http://lti.tools/oauth/
    suite('createSignatureKey()', function() {
      var element;
      var consumerSecret = 'W4yfjeCMLVgKmHhJAw3brNDqSeuJdddAoh0I7dkfMoy8nhEOV7';
      setup(function() {
        element = fixture('basic');
      });

      test('Computes key for consumer secret only', function() {
        var base = element.createSignatureKey(consumerSecret);
        var compare = 'W4yfjeCMLVgKmHhJAw3brNDqSeuJdddAoh0I7dkfMoy8nhEOV7&';
        assert.equal(base, compare);
      });

      test('Computes key for consumer secret and toekn secret', function() {
        var base = element.createSignatureKey(consumerSecret, 'test123');
        var compare = 'W4yfjeCMLVgKmHhJAw3brNDqSeuJdddAoh0I7dkfMoy8nhEOV7&test123';
        assert.equal(base, compare);
      });
    });

    // http://lti.tools/oauth/
    suite('getSignature()', function() {
      suite('HMAC-SHA1', function() {
        var element;
        var signatureMethod = 'HMAC-SHA1';
        setup(function() {
          element = fixture('basic');
          element.consumerSecret = 'secret';
        });

        var oauthParams = {
          oauth_consumer_key: 'key',
          oauth_token: 'token',
          oauth_signature_method: signatureMethod,
          oauth_timestamp: 137131201,
          oauth_nonce: '7d8f3e4a'
        };
        var url = 'http://example.com/request?param=value';

        test('Computes signature for POST', function() {
          var base = element.getSignature(signatureMethod, 'POST', url, oauthParams);
          var compare = '8CeIhnDtQl2somp1zcGwfKhfvkw=';
          assert.equal(base, compare);
        });

        test('Computes signature for GET', function() {
          var base = element.getSignature(signatureMethod, 'GET', url, oauthParams);
          var compare = 'Iwn2ka3vOpamW4o2JhDYCBPLw8Q=';
          assert.equal(base, compare);
        });

        test('Computes signature with body', function() {
          var body = 'bodyParam=bodyValue';
          var base = element.getSignature(signatureMethod, 'POST', url, oauthParams, undefined, body);
          var compare = 'nBi6dBdbHDK2YUMh3Z/LgqnGF8E=';
          assert.equal(base, compare);
        });

        test('Computes base string with callback parameter', function() {
          var oauthParams = {
            oauth_consumer_key: 'key',
            oauth_signature_method: 'HMAC-SHA1',
            oauth_timestamp: 1500143520,
            oauth_nonce: 'KoirwhdQhaHOuviMm1YydjVlcOZxJvOr',
            oauth_version: '1.0',
            oauth_callback: 'http://192.168.1.16:8081/components/auth-methods/demo/oauth1.html'
          };
          var url = 'http://term.ie/oauth/example/request_token.php';
          var base = element.getSignature(signatureMethod, 'POST', url, oauthParams);
          var compare = 'GR6Bkw3yD6luxFOC9emEFltYzNc=';
          assert.equal(base, compare);
        });
      });

      suite('PLAINTEXT', function() {
        var element;
        var signatureMethod = 'PLAINTEXT';
        setup(function() {
          element = fixture('basic');
          element.consumerSecret = 'secret';
        });

        var oauthParams = {
          oauth_consumer_key: 'key',
          oauth_token: 'token',
          oauth_signature_method: 'PLAINTEXT',
          oauth_timestamp: 137131201,
          oauth_nonce: '7d8f3e4a'
        };
        var url = 'http://example.com/request?param=value';

        test('Computes signature for POST', function() {
          var base = element.getSignature(signatureMethod, 'POST', url, oauthParams);
          assert.equal(base, 'secret&');
        });

        test('Computes signature for GET', function() {
          var base = element.getSignature(signatureMethod, 'GET', url, oauthParams);
          assert.equal(base, 'secret&');
        });
      });
    });

  });
  </script>
</body>

</html>
