<!doctype html>
<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <link rel="import" href="../oauth2-authorization.html">
  <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
</head>

<body>
  <test-fixture id="basic">
    <template>
      <oauth2-authorization></oauth2-authorization>
    </template>
  </test-fixture>
  <script>
  /* global fixture, assert, sinon */
  // jscs:disable requireCamelCaseOrUpperCaseIdentifiers
  // jscs:disable requireDotNotation
  var popupUrl = location.href.substr(0, location.href.lastIndexOf('/')).replace('/test', '');
  popupUrl += '/oauth-popup.html';
  var testState = 'test-state';
  function noop() {}
  suite('Implicit token', function() {
    suite('Popup', function() {
      suite('Error response', function() {
        var element;
        setup(function(done) {
          element = fixture('basic');
          element._type = 'implicit';
          element._state = testState;
          element._popup = {close: noop};
          setTimeout(done, 1000);
        });

        test('Dispatches oauth2-error for error response', function(done) {
          var eCode = 'test_error';
          var eMessage = 'test message';
          var url = popupUrl + '#state=' + testState + '&error=' + eCode + '&';
          url += 'error_description=' + encodeURIComponent(eMessage);
          var errorFn;
          var responseFn;
          errorFn = function(e) {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            assert.equal(e.detail.code, eCode);
            assert.equal(e.detail.state, testState);
            assert.equal(e.detail.message, eMessage);
            done();
          };
          responseFn = function() {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            done(new Error('oauth2-token-response should not be dispatched'));
          };
          element.addEventListener('oauth2-token-response', responseFn);
          element.addEventListener('oauth2-error', errorFn);
          element._authorize(url, {});
        });

        test('Dispatches oauth2-error for state mismatch', function(done) {
          var url = popupUrl + '#state=invalid&error=&error_message=';
          var errorFn;
          var responseFn;
          errorFn = function(e) {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            assert.equal(e.detail.code, 'invalid_state');
            assert.equal(e.detail.state, testState);
            assert.equal(e.detail.message, 'Invalid state returned by the OAuth server.');
            done();
          };
          responseFn = function() {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            done(new Error('oauth2-token-response should not be dispatched'));
          };
          element.addEventListener('oauth2-error', errorFn);
          element.addEventListener('oauth2-token-response', responseFn);
          element._authorize(url, {});
        });
      });

      suite('Token response', function() {
        var element;
        setup(function() {
          element = fixture('basic');
          element._type = 'implicit';
          element._state = testState;
          element._popup = {close: noop};
        });

        test('Dispatches oauth2-token-response', function(done) {
          var token = 'token1234';
          var expiresIn = 1234;
          var url = popupUrl + '#state=' + testState + '&access_token=';
          url += token + '&expires_in=' + expiresIn;

          var errorFn;
          var responseFn;
          errorFn = function() {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            done(new Error('oauth2-error should not be dispatched'));
          };

          responseFn = function(e) {
            element.removeEventListener('oauth2-error', errorFn);
            element.removeEventListener('oauth2-token-response', responseFn);
            assert.isUndefined(e.detail.code, 'code is undefined');
            assert.equal(e.detail.accessToken, token, 'Camel case accessToken is set');
            assert.equal(e.detail.access_token, token, 'access_token is set');
            assert.equal(e.detail.expiresIn, expiresIn, 'Camel case expiresIn is set');
            assert.equal(e.detail.expires_in, expiresIn, 'expires_in is set');
            done();
          };
          element.addEventListener('oauth2-error', responseFn);
          element.addEventListener('oauth2-token-response', responseFn);
          element._authorize(url, {});
        });
      });
    });

    suite('none interactive', function() {
      var settings = {
        interactive: false
      };

      suite('Error response', function() {
        var element;
        setup(function() {
          element = fixture('basic');
          element._type = 'implicit';
          element._state = testState;
        });

        test('Dispatches oauth2-error for error response', function(done) {
          var eCode = 'test_error';
          var eMessage = 'test message';
          var url = popupUrl + '#state=' + testState + '&error=' + eCode + '&';
          url += 'error_description=' + encodeURIComponent(eMessage);
          element._authorize(url, settings);
          element.addEventListener('oauth2-error', function clb(e) {
            element.removeEventListener('oauth2-error', clb);
            assert.equal(e.detail.code, eCode);
            assert.equal(e.detail.state, testState);
            assert.equal(e.detail.message, eMessage);
            assert.isFalse(e.detail.interactive);
            done();
          });
        });

        test('Does not dispatches oauth2-token-response event for error response', function(done) {
          var eCode = 'test_error';
          var eMessage = 'test message';
          var url = popupUrl + '#state=' + testState + '&error=' + eCode + '&';
          url += 'error_description=' + encodeURIComponent(eMessage);
          element._authorize(url, settings);
          var spy = sinon.spy();
          element.addEventListener('oauth2-token-response', spy);
          setTimeout(function() {
            assert.isFalse(spy.called);
            done();
          }, 800);
        });

        test('Dispatches oauth2-error for state mismatch', function(done) {
          var url = popupUrl + '#state=invalid&error=&error_message=';
          element._authorize(url, settings);
          element.addEventListener('oauth2-error', function clb(e) {
            element.removeEventListener('oauth2-error', clb);
            assert.equal(e.detail.code, 'invalid_state');
            assert.equal(e.detail.state, testState);
            assert.isFalse(e.detail.interactive);
            done();
          });
        });

        test('Does not dispatches oauth2-token-response event for state mismatch', function(done) {
          var url = popupUrl + '#state=invalid&error=&error_message=';
          element._authorize(url, settings);
          var spy = sinon.spy();
          element.addEventListener('oauth2-token-response', spy);
          setTimeout(function() {
            assert.isFalse(spy.called);
            done();
          }, 800);
        });

        test('Dispatches oauth2-token-response for lack of response', function(done) {
          // main docs page
          element._authorize(popupUrl.replace('oauth-popup.html', 'test/empty-popup.html'), settings);
          element.addEventListener('oauth2-token-response', function clb(e) {
            element.removeEventListener('oauth2-token-response', clb);
            assert.equal(e.detail.code, 'not_authorized');
            assert.equal(e.detail.state, testState);
            assert.isFalse(e.detail.interactive);
            done();
          });
        });
      });
      suite('Token response', function() {
        var element;
        setup(function() {
          element = fixture('basic');
          element._type = 'implicit';
          element._state = testState;
        });

        test('Dispatches oauth2-token-response', function(done) {
          var token = 'token1234';
          var expiresIn = 1234;
          var url = popupUrl + '#state=' + testState + '&access_token=';
          url += token + '&expires_in=' + expiresIn;
          element.addEventListener('oauth2-token-response', function clb(e) {
            element.removeEventListener('oauth2-token-response', clb);
            assert.isUndefined(e.detail.code, 'code is undefined');
            assert.equal(e.detail.accessToken, token, 'Camel case accessToken is set');
            assert.equal(e.detail.access_token, token, 'access_token is set');
            assert.equal(e.detail.expiresIn, expiresIn, 'Camel case expiresIn is set');
            assert.equal(e.detail.expires_in, expiresIn, 'expires_in is set');
            done();
          });
          element._authorize(url, settings);
        });
      });
    });
  });
  </script>
</body>
</html>
